name: PizzaCI - Express

on:
  workflow_dispatch:
    inputs:
      nom_client:
        description: "Nom du client"
        required: true
      pizzas:
        description: |
          Liste des pizzas au format JSON. Attention aux points importants:
          - Utilisez des guillemets doubles
          - Entourez la liste avec []
          Exemple: ["margherita","reine","calzone"]
        required: true

jobs:
  reception-commande:
    runs-on: ubuntu-latest
    outputs:
      pizzas: ${{ steps.extract.outputs.pizzas }}
    steps:
      - name: Message d'accueil
        run: echo "üçï Bienvenue ${{ github.event.inputs.nom_client }} chez PizzaCI - Express !"

      - name: Confirmation de la commande
        id: extract
        run: |
          echo "üì¶ Commande re√ßue pour les pizzas : ${{ github.event.inputs.pizzas }}"
          echo "pizzas=${{ github.event.inputs.pizzas }}" >> $GITHUB_OUTPUT

  cuisine:
    runs-on: ubuntu-latest
    needs: reception-commande
    strategy:
      matrix:
        pizza: ${{ fromJSON(needs.reception-commande.outputs.pizzas) }}
        taille: ["L", "XL"]
        include:
          - pizza: "choco-banana"
            taille: "L"
    steps:
      - name: Pr√©paration de la pizza
        run: echo "üë®‚Äçüç≥ Pr√©paration de la pizza ${{ matrix.pizza }} taille ${{ matrix.taille }}..."

  livraison:
    runs-on: ubuntu-latest
    needs: cuisine
    concurrency:
      group: livraison
      cancel-in-progress: true
    steps:
      - name: Pr√©paration de la livraison
        run: echo "üöö Livraison en cours pour ${{ github.event.inputs.nom_client }}"

      - name: R√©capitulatif des pizzas livr√©es
        run: |
          echo "üì¶ Pizzas en cours de livraison : ${{ github.event.inputs.pizzas }}"

  reclamation:
    runs-on: ubuntu-latest
    needs: livraison
    permissions:
      issues: write
    steps:
      - name: Checkout du d√©p√¥t
        uses: actions/checkout@v4

      - name: Cr√©ation de l'issue de r√©clamation (simulation)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue create --title "üßæ R√©clamation potentielle pour la commande de ${{ github.event.inputs.nom_client }}" \
            --body "Merci de v√©rifier que la livraison correspond bien aux attentes. Pizzas command√©es : ${{ github.event.inputs.pizzas }}"
